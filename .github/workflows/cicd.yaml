name: CICD Pipeline

on:
  push:
    branches:
      - master   # ðŸ‘ˆ or 'main' if that's your default branch

jobs:
  model-deployment:
    runs-on: ubuntu-latest

    steps:
    # ======================================================
    # âœ… STEP 1 â€” CHECKOUT REPO (with full history)
    # Needed for accurate git diff between commits
    # ======================================================
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0   # ðŸŸ¡ critical for git diff to work correctly

    # ======================================================
    # âœ… STEP 2 â€” SETUP PYTHON
    # ======================================================
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # ======================================================
    # âœ… STEP 3 â€” CACHE DEPENDENCIES
    # Makes repeated builds faster by reusing pip cache
    # ======================================================
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Upgrade pip and install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt

    # ======================================================
    # ðŸŸ¡ STEP 4 â€” CHECK FOR PIPELINE CHANGES
    # This step detects if files relevant to the DVC/ML pipeline changed.
    # If not, we skip running the pipeline to save time and S3 bandwidth.
    # ======================================================
    - name: Check for pipeline changes
      id: check_pipeline
      run: |
        # Fallback: if no base commit, run pipeline by default (e.g. first push)
        if [ -z "${{ github.event.before }}" ]; then
          echo "No base commit detected. Running pipeline by default."
          echo "run_dvc=true" >> $GITHUB_ENV
          exit 0
        fi

        git fetch origin ${{ github.ref }}
        CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
        echo "Changed files:"
        echo "$CHANGED_FILES"

        if echo "$CHANGED_FILES" | grep -E '(^dvc\.yaml$|^dvc\.lock$|^params\.yaml$|^data/|^src/)'; then
          echo "Relevant pipeline changes detected âœ…"
          echo "run_dvc=true" >> $GITHUB_ENV
        else
          echo "No relevant pipeline changes detected â©"
          echo "run_dvc=false" >> $GITHUB_ENV
        fi

    # ======================================================
    # âœ… STEP 5 â€” RUN DVC PIPELINE IF CHANGES DETECTED
    # If hashes haven't changed, skip repro.
    # ======================================================
    - name: Run DVC Pipeline
      if: env.run_dvc == 'true'
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: eu-north-1
        MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
      run: |
        if dvc status -c | grep -q "Data and pipelines are up to date."; then
          echo "No DVC changes detected. Skipping repro."
        else
          dvc repro
        fi

    # ======================================================
    # âœ… STEP 6 â€” PUSH DVC DATA TO REMOTE
    # Only runs when DVC pipeline actually ran.
    # ======================================================
    - name: Push DVC-tracked data to remote
      if: env.run_dvc == 'true'
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: eu-north-1
      run: |
        dvc push

    # ======================================================
    # âœ… STEP 7 â€” CONFIGURE GIT
    # Required for committing lockfile changes in CI.
    # ======================================================
    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

    # ======================================================
    # âœ… STEP 8 â€” COMMIT DVC LOCKFILE CHANGES (IF ANY)
    # Avoids empty commits when no changes happened.
    # ======================================================
    - name: Commit and Push DVC Lockfile Changes
      if: env.run_dvc == 'true'
      run: |
        git add dvc.lock
        git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ”„ Update dvc.lock after pipeline run"
        git push origin ${{ github.ref_name }}

    # ======================================================
    # âœ… STEP 9 â€” REGISTER MODEL IN MLFLOW (Only if pipeline ran)
    # This ensures the model is available for tests.
    # ======================================================
    - name: Register model in MLflow
      if: env.run_dvc == 'true'
      run: python src/model/register_model.py

    # ======================================================
    # âœ… STEP 10 â€” INSTALL TEST DEPENDENCIES
    # ======================================================
    - name: Install test dependencies
      run: pip install pytest

    # ======================================================
    # âœ… STEP 11 â€” RUN MODEL TESTS
    # These only run if the pipeline executed and registered a model.
    # Prevents failures on pushes that didn't modify the pipeline.
    # ======================================================
    - name: Run model loading test
      if: env.run_dvc == 'true'
      run: pytest scripts/test_model_loading.py

    - name: Run model signature test
      if: env.run_dvc == 'true'
      run: pytest scripts/test_model_signature.py

    - name: Run model accuracy test
      if: env.run_dvc == 'true'
      run: pytest scripts/test_model_accuracy.py
    - name: Run API tests
      run: |
          # Start the Flask app in the background
           nohup python app.py &

          # Wait a few seconds for the API to start
           sleep 5

          # Run pytest on your API tests
           pytest tests/test_api.py
